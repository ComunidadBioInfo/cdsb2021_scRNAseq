# AnotaciÃ³n de clusters de cÃ©lulas

# Diapositivas de Peter Hickey

Ver las diapositivas originales [aquÃ­](https://docs.google.com/presentation/d/1CW-7FjL34kIKVEoZ2L_RVdXoEKQVzRbEuFUDVGJqnXI/edit)

Plantilla desarrollada por: [Leonardo Collado-Torres](http://lcolladotor.github.io/)

---

class: inverse center middle

# MotivaciÃ³n

---

# MotivaciÃ³n

## Ahora estamos a punto de obtener la interpretaciÃ³n biolÃ³gica de los resultados 
### Esta es la tarea mÃ¡s retadora en los anÃ¡lisis de datos scRNA-seq

---

# MotivaciÃ³n

* ğŸ‘‰ La obtenciÃ³n de clÃºsteres es mÃ¡s o menos directa
* ğŸ¤” Â¿CuÃ¡l es el estado biolÃ³gico que estÃ¡ representado por cada uno de los clÃºsteres?

* ğŸ‘‰ Necesitamos hacer un puente entre el _gap_ del dataset actual y el conocimiento biolÃ³gico a priori (no siempre estÃ¡ disponible en una forma consistente y cualitativa)

* ğŸ¤” Â¿QuÃ© es un tipo celular?
* ğŸ”¬ "Lo sabrÃ© cuando lo vea"
* ğŸ’» "No"

---

# MotivaciÃ³n

Aplicaremos varios mÃ©todos computacionales que explotan la informaciÃ³n _a priori_ para asignar el significado a un dataset no caracterizado de scRNA-seq.

Algunas fuentes de informaciÃ³n _a priori_
- Conjuntos de genes curados (e.g. Gene Ontology)
- Perfiles de expresiÃ³n de bases de datos publicadas de referencia
- Los datos raros que tÃº hayas escondido en tu cerebro
- Google

---

class: inverse center middle

# Dataset ilustrativo: PBMC4k 10X sin filtrar

---

# Dataset ilustrativo: PBMC4k 10X sin filtrar

```{r, warning=FALSE, message=FALSE}
library(BiocFileCache)
bfc <- BiocFileCache()
raw.path <- bfcrpath(bfc, file.path(
    "http://cf.10xgenomics.com/samples",
    "cell-exp/2.1.0/pbmc4k/pbmc4k_raw_gene_bc_matrices.tar.gz"
))
untar(raw.path, exdir = file.path(tempdir(), "pbmc4k"))
```

---

# Dataset ilustrativo: PBMC4k 10X sin filtrar

```{r, warning=FALSE, message=FALSE}
library(DropletUtils)
library(Matrix)
fname <- file.path(tempdir(), "pbmc4k/raw_gene_bc_matrices/GRCh38")
sce.pbmc <- read10xCounts(fname, col.names = TRUE)
```

Dataset "CÃ©lulas mononucleares humanas de sangre perifÃ©rica" de 10X Genomics

DescripciÃ³n [aquÃ­](https://osca.bioconductor.org/unfiltered-human-pbmcs-10x-genomics.html)

.footnote[Zheng, G. X. Y. et al. Massively parallel digital transcriptional profiling of single cells. Nat. Commun. 8, 14049 (2017)]

---

# Dataset ilustrativo: PBMC4k 10X sin filtrar

```{r, warning=FALSE, message=FALSE}
# gene-annotation
library(scater)
rownames(sce.pbmc) <- uniquifyFeatureNames(
    rowData(sce.pbmc)$ID, rowData(sce.pbmc)$Symbol
)
library(EnsDb.Hsapiens.v86)
location <- mapIds(EnsDb.Hsapiens.v86,
    keys = rowData(sce.pbmc)$ID,
    column = "SEQNAME", keytype = "GENEID"
)
# cell-detection
set.seed(100)
e.out <- emptyDrops(counts(sce.pbmc))
sce.pbmc <- sce.pbmc[, which(e.out$FDR <= 0.001)]
```

.footnote[Zheng, G. X. Y. et al. Massively parallel digital transcriptional profiling of single cells. Nat. Commun. 8, 14049 (2017)]

---

# Dataset ilustrativo: PBMC4k 10X sin filtrar

```{r, warning=FALSE, message=FALSE}
# quality-control
stats <- perCellQCMetrics(sce.pbmc,
    subsets = list(Mito = which(location == "MT"))
)
high.mito <- isOutlier(stats$subsets_Mito_percent,
    type = "higher"
)
sce.pbmc <- sce.pbmc[, !high.mito]

# normalization
library(scran)
set.seed(1000)
clusters <- quickCluster(sce.pbmc)
sce.pbmc <- computeSumFactors(sce.pbmc, cluster = clusters)
sce.pbmc <- logNormCounts(sce.pbmc)
```

.footnote[Zheng, G. X. Y. et al. Massively parallel digital transcriptional profiling of single cells. Nat. Commun. 8, 14049 (2017)]

---

# Dataset ilustrativo: PBMC4k 10X sin filtrar

```{r, warning=FALSE, message=FALSE}
# variance modelling
set.seed(1001)
dec.pbmc <- modelGeneVarByPoisson(sce.pbmc)
top.pbmc <- getTopHVGs(dec.pbmc, prop = 0.1)
```

.footnote[Zheng, G. X. Y. et al. Massively parallel digital transcriptional profiling of single cells. Nat. Commun. 8, 14049 (2017)]

---

# Dataset ilustrativo: PBMC4k 10X sin filtrar

```{r, warning=FALSE, message=FALSE}
# dimensionality-reduction
set.seed(10000)
sce.pbmc <- denoisePCA(sce.pbmc,
    subset.row = top.pbmc,
    technical = dec.pbmc
)

set.seed(100000)
sce.pbmc <- runTSNE(sce.pbmc, dimred = "PCA")

set.seed(1000000)
sce.pbmc <- runUMAP(sce.pbmc, dimred = "PCA")
```

.footnote[Zheng, G. X. Y. et al. Massively parallel digital transcriptional profiling of single cells. Nat. Commun. 8, 14049 (2017)]

---

# Dataset ilustrativo: PBMC4k 10X sin filtrar

```{r, warning=FALSE, message=FALSE}
# clustering
g <- buildSNNGraph(sce.pbmc, k = 10, use.dimred = "PCA")
clust <- igraph::cluster_walktrap(g)$membership
sce.pbmc$cluster <- factor(clust)
```

.footnote[Zheng, G. X. Y. et al. Massively parallel digital transcriptional profiling of single cells. Nat. Commun. 8, 14049 (2017)]

---

class: inverse center middle

# Asignando las etiquetas celulares a partir de los datos de referencia

---

# Overview

* ğŸ‘‰ Un enfoque directo es comparar los perfiles de expresiÃ³n single-cell con datasets previamente anotados
* ğŸ‘‰ Las etiquetas pueden entonces ser asignadas a cada cÃ©lula en nuestro dataset no caracterizado de prueba basado en la muestra de referencia mÃ¡s similar, por dar alguna definiciÃ³n de "similar"

---

# Overview

* ğŸ‘‰ Cualquier dataset de expresiÃ³n gÃ©nica etiquetado (microarreglos, RNA-seq bulk, scRNA-seq) puede ser usado como una referencia
* âš ï¸ Sin embargo, su confiabilidad depende enormemente en la calidad de los datos originales y la experiencia de los autores originales quienes asignaron las etiquetas en primer lugar

---

# Overview

* ğŸ‘‰ Asignar las etiquetas a un dataset de "prueba" a partir de un dataset de "entrenamiento" (referencia), es un problema estÃ¡ndar en estadÃ­stica / _machine learning_
* ğŸ‘‰ Usaremos el mÃ©todo [SingleR (Aran et al. 2019)](https://bioconductor.org/packages/release/bioc/html/SingleR.html)

---

# SingleR

* ğŸ¤“ Asigna las etiquetas a las cÃ©lulas basado en las muestras de referencia con las correlaciones de rangos mÃ¡s altas de Spearman
* ğŸ¤“ Para reducir el ruido, identifica genes marcadores entre pares de etiquetas (en la referencia) y calcula la correlaciÃ³n usando solamente esos marcadores 
* ğŸ¤“ Hace algÃºn tipo de tuneado fino, repitiendo las correlaciones solamente con los genes marcadores de las etiquetas con el mejor score, ayudando a resolver cualquier ambigÃ¼edad entre esas etiquetas al eliminar el ruido a partir de marcadores irrelevantes para otras etiquetas

---

# SingleR incluye varias referencias

[Ver referencias](https://bioconductor.org/packages/3.11/bioc/vignettes/SingleR/inst/doc/SingleR.html#5_available_references)
```{r, warning=FALSE, message=FALSE}
# Human
# SingleR::BlueprintEncodeData()
# SingleR::DatabaseImmuneCellExpressionData()
# SingleR::HumanPrimaryCellAtlasData()
# SingleR::MonacoImmuneData()
# SingleR::NovershternHematopoieticData()

# Mice
# SingleR::ImmGenData()
# SingleR::MouseRNASeqData()
```

---

# Usando las referencias

```{r, warning=FALSE, message=FALSE}
# if needed install celldex
# create directory? y
library(SingleR)
ref <- BlueprintEncodeData()
```

â“ Â¿QuÃ© tipos celulares estÃ¡n disponibles en este dataset de referencia? 

---

# Usando las referencias integradas

```{r, warning=FALSE, message=FALSE}
pred <- SingleR(
    test = sce.pbmc, ref = ref,
    labels = ref$label.main
)
```

* â“ Â¿QuÃ© etiquetas han sido asignadas a los datos single-cell?
* â“ Â¿CÃ³mo usarÃ­amos las etiquetas "finas" con SingleR?

---

# Usando las referencias integradas

```{r, warning=FALSE, message=FALSE, fig.show='hide'}
plotScoreHeatmap(pred)
```

* ğŸ‘‰ Inspeccionamos los resultados usando un heatmap de los scores por cÃ©lula y por etiqueta
* ğŸ‘‰ Idealmente, cada cÃ©lula deberÃ­a exhibir un score alto en una etiqueta relativa a todas las otras
* ğŸ‘‰ Los scores se muestran antes de cualquier tuneado fino y son normalizadas a [0, 1] dentro de cada cÃ©lula

---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
plotScoreHeatmap(pred)
```

---

# Podado de etiquetas (Label pruning)

```{r, warning=FALSE, message=FALSE, fig.show='hide'}
total_pruned <- sum(is.na(pred$pruned.labels))
plotScoreHeatmap(pred, show.pruned = TRUE)
```

* ğŸ‘‰ SingleR intentarÃ¡ podar aquellas asignaciones de baja calidad marcÃ¡ndolas como NA
* ğŸ¤“ El podado se hace calculando la diferencia del score de la etiqueta asignada a partir del score de la mediana dentro de cada cÃ©lula y entonces podando las cÃ©lulas con un valor pequeÃ±o de esta diferencia

---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
plotScoreHeatmap(pred, show.pruned = TRUE)
```

---

# Podado de etiquetas (Label pruning)

```{r, warning=FALSE, message=FALSE, fig.show='hide'}
plotScoreDistribution(pred)
```

ğŸ‘‰ DistribuciÃ³n de las diferencias del score de la etiqueta asignada a partir del score de la mediana dentro de cada cÃ©lula

---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
plotScoreDistribution(pred)
```

---

# Identificando los genes con anotaciÃ³n dirigida

* ğŸ¤” Â¿Por quÃ© las cÃ©lulas en este clÃºster se etiquetan como el tipo celular X?
* ğŸ‘‰ Examina la expresiÃ³n de los genes marcadores para cada etiqueta en el dataset de prueba
* ğŸ‘‰ Si una cÃ©lula en el dataset de prueba estÃ¡ asignado con confianza a una etiqueta en particular, uno esperarÃ­a que tenga una fuerte expresiÃ³n de los marcadores de esa etiqueta (al menos sobreexpresiÃ³n con respecto a las cÃ©lulas asignadas a otras etiquetas)

---

# Identificando los genes con anotaciÃ³n dirigida

```{r, warning=FALSE, message=FALSE, fig.show='hide'}
# install gmp, ClusterR, mbkmeans dependencies if needed
library(clusterExperiment)
sce.pbmc$labels <- pred$labels
all.markers <- metadata(pred)$de.genes
lab <- "B-cells"
# Get top-10 marker genes for B-cells compared to each other cell
# type
top.markers <- Reduce(union, sapply(all.markers[[lab]], head, 10))

# plotHeatmap(sce.pbmc, order_columns_by="labels",
#  features=top.markers, center=TRUE, zlim=c(-3, 3), main=lab)
```

â“ Toma otro tipo celular e identifica los genes que dirigen la anotaciÃ³n

---

# Comparando las etiquetas con los clÃºsteres

```{r, warning=FALSE, message=FALSE, fig.show='hide'}
tab <- table(Assigned = pred$pruned.labels, Cluster = sce.pbmc$cluster)

library(pheatmap)
# Proportion of cells in each cluster assigned to each label
pheatmap(prop.table(tab, margin = 2),
    color = colorRampPalette(c("white", "blue"))(101)
)
# (log-)number of cells in each cluster assigned to each label
# Adding a pseudo-count of 10 to avoid strong color jumps with just
# 1 cell.
pheatmap(log2(tab + 10),
    color = colorRampPalette(c("white", "blue"))(101)
)
```

---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
pheatmap(prop.table(tab, margin = 2),
    color = colorRampPalette(c("white", "blue"))(101)
)
```

---

```{r, warning=FALSE, message=FALSE, echo=FALSE}
pheatmap(log2(tab + 10),
    color = colorRampPalette(c("white", "blue"))(101)
)
```

---

# VoilÃ 

```{r, warning=FALSE, message=FALSE}
plotTSNE(sce.pbmc, colour_by = "labels", text_by = "labels")
```

---

# Resumen de la anotaciÃ³n basada en una referencia (e.g., SingleR)

* â• Se centra en aspectos de los datos que se sabe son interesantes, simplifica el proceso de la interpretaciÃ³n biolÃ³gica 
* â– EstÃ¡ restringido por la diversidad y la resoluciÃ³n de las etiquetas disponibles en el dataset de referencia
* ğŸ‘‰ Se pueden suplir referencias personalizadas a SingleR

---

class: inverse center middle

# Asignando las etiquetas de tipos celulares a partir de marcadores

---

# Asignando las etiquetas de tipos celulares a partir de marcadores

* ğŸ¤” Â¿CÃ³mo podemos hacer uso de nuestros genes marcadores agrupados?
* ğŸ¥‰ Revisarlos en hojas de cÃ¡lculo 
* ğŸ¥ˆ Observar heatmaps
* ğŸ¥‡ Realizar un gene set enrichment analysis

---

# Gene set enrichment analysis

* ğŸ‘‰ Identifica las rutas y procesos que estÃ¡n (relativamente) activos en cada clÃºster basado en la sobreexpresiÃ³n de los genes asociados en comparaciÃ³n con otros clÃºsteres
* â• Un mÃ©todo confiable para determinar si las rutas estÃ¡n sobre- o sub- expresadas entre clÃºesteres 
* â• Existen un montÃ³n de herramientas para gene set enrichment analysis
* â– Todas las conclusiones son relativas a otros clÃºsteres, haciÃ©ndolo mÃ¡s difÃ­cil para determinar la identidad celular si alguno no estÃ¡ presente en el mismo estudio [mÃ¡s info](https://osca.bioconductor.org/cell-type-annotation.html#assigning-cluster-labels-from-markers)

---

class: inverse center middle

# Calculando las actividades de los conjuntos de genes

---

# Calculando las actividades de los conjuntos de genes

* ğŸ‘‰ Calcular el promedio de la expresiÃ³n en log en todos los genes, en un conjunto de genes para cada cÃ©lula y examinar los clÃºsteres con valores altos (_gene set activities_)
* ğŸ‘‰ Se necesita proveer de conjuntos de genes 
* â– No todos los genes en el conjunto pueden exhibir el mismo patrÃ³n de diferencia y los genes no-DE aÃ±adirÃ¡n ruido, "diluyendo" la fuerza de cualquiera de las diferencias comparadas a un anÃ¡lisis que se centra directamente en genes DE 
* ğŸ‘‰ Es mÃ¡s una visualizaciÃ³n Ãºtil que la base para cualquier anÃ¡lisis estadÃ­stico real [mÃ¡s info](https://osca.bioconductor.org/cell-type-annotation.html#computing-gene-set-activities)

---

class: inverse center middle

# Resumen y recomendaciones

---

# Resumen y recomendaciones

* ğŸ‘‰ La anotaciÃ³n de tipos celulares "automÃ¡tica", como SingleR, es mejor cuando funciona (i.e. cuando hay un dataset de referencia apropiado)
* ğŸ‘‰ Usualmente necesitaremos usar un mÃ©todo manual, como aquellos basados en agrupar los genes marcadores  (e.g., gene set enrichment analysis)
* ğŸ‘‰ La anotaciÃ³n del tipo celular ofrecerÃ¡ una reconsideraciÃ³n inmediata de los parÃ¡metros del agrupamiento y/o algunos retoques manuales a los clÃºsteres 

## Detalles de la sesiÃ³n de R

```{r}
## InformaciÃ³n de la sesiÃ³n de R
Sys.time()
proc.time()
options(width = 120)
sessioninfo::session_info()
```

## Patrocinadores {-}

Agradecemos a nuestros patrocinadores:

<a href="https://comunidadbioinfo.github.io/es/post/cs_and_s_event_fund_award/#.YJH-wbVKj8A"><img src="https://comunidadbioinfo.github.io/post/2021-01-27-cs_and_s_event_fund_award/spanish_cs_and_s_award.jpeg" width="400px" align="center"/></a>

<a href="https://www.r-consortium.org/"><img src="https://www.r-consortium.org/wp-content/uploads/sites/13/2016/09/RConsortium_Horizontal_Pantone.png" width="400px" align="center"/></a>
